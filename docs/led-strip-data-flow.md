# LED灯带数据流文档

本文档描述了环境光控制应用程序中LED灯带配置和测试的完整数据流。

## 1. LED灯带配置结构

### 1.1 前端配置对象

每个LED灯带配置包含以下属性：

- `id`: 唯一标识符（如 "display_2_bottom"）
- `border`: 物理位置（"bottom", "right", "top", "left"）
- `count`: 灯带中LED的数量
- `ledType`: LED芯片类型（"WS2812B" 或 "SK6812"）
- `sequence`: 在当前驱动器中，灯带的连接顺序，即数据流中的顺序（1, 2, 3, 4）
- `reverse`: 是否反转LED顺序，当灯带数据流向与默认的屏幕边的方向相反时，使用这个选项纠正
- `startOffset`: 起始位置百分比（0-100%）
- `endOffset`: 结束位置百分比（0-100%）

### 1.2 后端配置格式

后端期望的配置格式：

```rust
pub struct LedStripConfig {
    pub border: String,        // "bottom", "right", "top", "left"
    pub count: u32,           // LED数量
    pub led_type: String,     // "WS2812B" 或 "SK6812"
    pub sequence: u32,        // 数据流中的顺序
    pub reverse: bool,        // 反转LED顺序
    pub start_pos: u32,       // 起始LED位置
    pub len: u32,            // 使用的LED数量
}
```

## 2. 物理连接和数据协议

### 2.1 硬件设置

- LED灯带按顺序连接：灯带1 → 灯带2 → 灯带3 → 灯带4
- 每个灯带在数据流中的特定字节偏移量处接收数据
- 数据格式取决于LED类型：
  - WS2812B: 每个LED 3字节（G, R, B）
  - SK6812: 每个LED 4字节（G, R, B, W）

### 2.2 通信协议

应用程序使用协议命令0x02发送LED数据：

- 命令: 0x02
- 偏移量: 数据流中的字节位置
- 长度: 要发送的字节数
- 数据: LED的颜色数据

## 3. 屏幕颜色采样流程

### 3.1 颜色提取过程

1. **屏幕捕获**: 捕获显示器内容
2. **边框采样**: 从屏幕边缘提取颜色
3. **颜色处理**: 应用亮度、饱和度调整
4. **LED映射**: 根据位置将颜色映射到各个LED

### 3.2 边框颜色映射

- **底边**: 映射到底部LED灯带
- **右边**: 映射到右侧LED灯带
- **顶边**: 映射到顶部LED灯带
- **左边**: 映射到左侧LED灯带

## 4. 数据流管道

### 4.1 正常操作（屏幕镜像）

```
屏幕捕获 → 颜色提取 → 颜色处理 → LED映射 → 硬件传输
```

### 4.2 测试模式操作

```
测试颜色生成 → LED映射 → 硬件传输
```

## 5. 偏移量和采样计算逻辑

### 5.1 屏幕采样范围计算

`startOffset` 和 `endOffset` 定义了LED灯带在屏幕边缘的物理摆放位置：

**示例**：屏幕右边有1080个像素，灯带配置为：

- `startOffset`: 20%（起始位置）
- `endOffset`: 90%（结束位置）
- `count`: 20个LED

**采样计算**：

1. **采样起始像素**: 1080 × 20% = 216像素
2. **采样结束像素**: 1080 × 90% = 972像素
3. **采样范围**: 972 - 216 = 756像素
4. **每LED采样区域**: 756 ÷ 20 = 37.8像素/LED

系统将把216-972像素范围平分为20个区域，每个区域的颜色映射到对应的LED上。

### 5.2 数据流字节偏移量计算

LED灯带在硬件数据流中的字节偏移量：

1. 按序列号对灯带排序
2. 累积计算每个灯带在数据流中的字节位置
3. 根据LED类型计算字节数

**计算示例**：

- 灯带1（序列1）: 38个LED，SK6812 → 38 × 4 = 152字节，字节偏移量 = 0
- 灯带2（序列2）: 22个LED，WS2812B → 22 × 3 = 66字节，字节偏移量 = 152

**注意**：屏幕采样范围（startOffset/endOffset）与硬件数据流偏移量是两个不同的概念：

- **采样范围**：决定从屏幕的哪个区域提取颜色
- **字节偏移量**：决定LED数据在硬件数据流中的位置

## 6. 测试颜色生成

### 6.1 颜色方案

每个边框显示两种不同的颜色用于识别：

- **底边**: 紫色 + 青色
- **右边**: 绿色 + 蓝色
- **顶边**: 蓝色 + 黄色
- **左边**: 黄色 + 红色

### 6.2 颜色分布

- LED的前半部分：第一种颜色
- LED的后半部分：第二种颜色
- 如果启用反转：颜色顺序反转

## 7. 硬件通信

### 7.1 数据传输

- 协议: 自定义二进制协议
- 命令: 0x02（LED数据）
- 频率: 30 FPS用于平滑更新
- 数据格式: 原始颜色字节

### 7.2 LED灯带类型

- **WS2812B**: 每个LED 3字节（绿，红，蓝）
- **SK6812**: 每个LED 4字节（绿，红，蓝，白）

## 8. 测试和调试

### 8.1 测试模式验证

- 每个边框应显示其特征颜色
- 颜色应出现在正确的物理LED灯带上
- LED顺序应与配置的序列匹配

### 8.2 调试信息

- 记录每个灯带的偏移量计算
- 验证字节偏移量与预期硬件位置匹配
- 检查颜色数据格式和长度

### 8.3 硬件验证

- 使用示波器验证数据时序
- 检查LED控制器在正确偏移量处接收数据
- 验证颜色数据格式与LED灯带要求匹配

## 9. 当前问题分析

基于日志显示：

- 灯带1: 偏移量0，152字节（SK6812约38个LED）
- 灯带2: 偏移量114，66字节（WS2812B约22个LED）

### 9.1 潜在问题

1. **偏移量间隙**: 第一个灯带152字节，但第二个灯带从114字节开始
   - 预期: 第二个灯带应从偏移量152开始（第一个灯带之后）
   - 实际: 第二个灯带从偏移量114开始（与第一个灯带重叠）

2. **颜色映射**: 右边框应显示绿色+蓝色，但可能显示错误颜色
   - 前端测试颜色与LedColorService不一致
   - 已修复: 更新前端以匹配正确的颜色方案

### 9.2 调试步骤

1. 检查配置中的灯带序列号和LED数量
2. 验证前端的累积偏移量计算
3. 比较前端偏移量计算与后端期望
4. 验证颜色数据格式（GRB vs RGB）

### 9.3 预期颜色方案（修复后）

- **底边**: 紫色 + 青色
- **右边**: 绿色 + 蓝色
- **顶边**: 蓝色 + 黄色
- **左边**: 黄色 + 红色

## 10. 偏移量计算错误分析

### 10.1 问题根源

从日志可以看出，第二个灯带的偏移量114字节是错误的：

- 第一个灯带: 38个LED × 4字节(SK6812) = 152字节
- 第二个灯带应该从偏移量152开始，而不是114

### 10.2 可能的原因

1. **序列号重复**: 两个灯带可能有相同的序列号
2. **累积计算错误**: 前端的累积偏移量计算逻辑有问题
3. **LED类型混淆**: 计算时使用了错误的每LED字节数

### 10.3 解决方案

1. 添加详细的调试日志来跟踪偏移量计算过程
2. 检查灯带配置中的序列号是否唯一
3. 验证每个灯带的LED类型和字节数计算

### 10.4 调试信息要求

请在浏览器控制台中查看以下调试信息：

- 灯带排序结果
- 每个灯带的序列号、LED数量、LED类型
- 累积偏移量计算过程
- 是否有重复的序列号警告
